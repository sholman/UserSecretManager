<suki:SukiWindow xmlns="https://github.com/avaloniaui"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:vm="using:UserSecretManager.ViewModels"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:suki="using:SukiUI.Controls"
                 xmlns:views="using:UserSecretManager.Views"
                 xmlns:controls="using:UserSecretManager.Controls"
                 mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
                 x:Class="UserSecretManager.Views.MainWindow"
                 x:DataType="vm:MainWindowViewModel"
                 Title=".NET User Secrets Manager"
                 Width="1200" Height="800"
                 MinWidth="800" MinHeight="600">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Folder..." Command="{Binding OpenFolderCommand}" InputGesture="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="_Save" Command="{Binding SaveCurrentCommand}" InputGesture="Ctrl+S"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="OnExitClick"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Format JSON" Command="{Binding SelectedSecrets.FormatJsonCommand}" 
                          IsEnabled="{Binding SelectedSecrets.IsValidJson}"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Click="OnAboutClick"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Padding="8" Background="{DynamicResource SukiCardBackground}">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <Button Content="ðŸ“‚ Open Folder" Command="{Binding OpenFolderCommand}"/>
                    <Button Content="ðŸ’¾ Save" Command="{Binding SaveCurrentCommand}" 
                            IsEnabled="{Binding SelectedSecrets.IsDirty}"/>
                </StackPanel>
                
                <TextBox Grid.Column="2" 
                         Text="{Binding SearchText}" 
                         Watermark="Filter projects..." 
                         Width="250"/>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" Padding="8,4" Background="{DynamicResource SukiCardBackground}">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                
                <TextBlock Grid.Column="1" Margin="16,0" VerticalAlignment="Center"
                           IsVisible="{Binding SelectedSecrets, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Run Text="GUID: "/>
                    <Run Text="{Binding SelectedSecrets.UserSecretsId}" FontFamily="Consolas,Monaco,monospace"/>
                </TextBlock>
                
                <Border Grid.Column="2" Margin="8,0" Padding="8,2" CornerRadius="4"
                        IsVisible="{Binding SelectedSecrets, Converter={x:Static ObjectConverters.IsNotNull}}"
                        Background="{Binding SelectedSecrets.IsValidJson, 
                            Converter={StaticResource BoolToValidationColorConverter}}">
                    <TextBlock Text="{Binding SelectedSecrets.IsValidJson, 
                                   Converter={StaticResource BoolToValidationTextConverter}}"
                               Foreground="White" FontWeight="Bold"/>
                </Border>
                
                <TextBlock Grid.Column="3" Margin="8,0" VerticalAlignment="Center"
                           IsVisible="{Binding SelectedSecrets.LastModified, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Run Text="Last saved: "/>
                    <Run Text="{Binding SelectedSecrets.LastModified, StringFormat='{}{0:HH:mm:ss}'}"/>
                </TextBlock>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid>
            <!-- Empty State -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                        IsVisible="{Binding !Projects.Count}">
                <TextBlock Text="ðŸ”" FontSize="64" HorizontalAlignment="Center" Margin="0,0,0,16"/>
                <TextBlock Text=".NET User Secrets Manager" FontSize="24" FontWeight="Bold" 
                           HorizontalAlignment="Center" Margin="0,0,0,8"/>
                <TextBlock Text="Open a folder to scan for .NET projects with User Secrets" 
                           HorizontalAlignment="Center" Opacity="0.7" Margin="0,0,0,24"/>
                <Button Content="ðŸ“‚ Open Folder" Command="{Binding OpenFolderCommand}" 
                        HorizontalAlignment="Center" Padding="24,12"/>
            </StackPanel>
            
            <!-- Loading State -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                        IsVisible="{Binding IsScanning}">
                <suki:Loading/>
                <TextBlock Text="Scanning for projects..." Margin="0,16,0,0" HorizontalAlignment="Center"/>
            </StackPanel>

            <!-- Main Split View -->
            <Grid ColumnDefinitions="280,8,*" IsVisible="{Binding Projects.Count}">
                <!-- Left Sidebar - Project List -->
                <Border Grid.Column="0" Background="{DynamicResource SukiCardBackground}" 
                        CornerRadius="8" Margin="8" Padding="8">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="Projects" FontWeight="Bold" 
                                   Margin="8,4,8,12" FontSize="14"/>
                        <ListBox ItemsSource="{Binding Projects}"
                                 SelectedItem="{Binding SelectedProject}"
                                 Background="Transparent">
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="vm:ProjectListItemViewModel">
                                    <Border Padding="8" IsVisible="{Binding IsVisible}">
                                        <StackPanel Spacing="4">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding UserSecretsId}" 
                                                       FontSize="11" Opacity="0.6"
                                                       FontFamily="Consolas,Monaco,monospace"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>

                <!-- Splitter -->
                <GridSplitter Grid.Column="1" Width="8" Background="Transparent"/>

                <!-- Right Content - Secrets Editor -->
                <Grid Grid.Column="2" Margin="0,8,8,8"
                      IsVisible="{Binding SelectedSecrets, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <!-- Secrets Editor -->
                    <Grid RowDefinitions="Auto,*">
                        <!-- Project Info Header -->
                        <Border Grid.Row="0" Padding="12" Background="{DynamicResource SukiCardBackground}"
                                Margin="0,0,0,8" CornerRadius="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0" Spacing="4">
                                    <TextBlock Text="{Binding SelectedSecrets.ProjectName}" FontSize="18" FontWeight="Bold"/>
                                    <TextBlock Text="{Binding SelectedSecrets.ProjectPath}" Opacity="0.6" FontSize="12"
                                               TextTrimming="CharacterEllipsis"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                    <Button Content="Format JSON" Command="{Binding SelectedSecrets.FormatJsonCommand}"
                                            IsEnabled="{Binding SelectedSecrets.IsValidJson}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Split View: AppSettings (left) and User Secrets (right) -->
                        <Grid Grid.Row="1" ColumnDefinitions="*,8,*">
                            <!-- AppSettings Panel -->
                            <Border Grid.Column="0" CornerRadius="8" ClipToBounds="True"
                                    Background="{DynamicResource SukiCardBackground}">
                                <Grid RowDefinitions="44,*">
                                    <!-- AppSettings Header with Dropdown -->
                                    <Border Grid.Row="0" Padding="12,0"
                                            BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,0,1">
                                        <Grid ColumnDefinitions="Auto,*" VerticalAlignment="Center">
                                            <TextBlock Grid.Column="0" Text="ðŸ“„ AppSettings" FontWeight="SemiBold" 
                                                       VerticalAlignment="Center" Margin="0,0,12,0"/>
                                            <ComboBox Grid.Column="1" 
                                                      ItemsSource="{Binding SelectedSecrets.AppSettingsFiles}"
                                                      SelectedItem="{Binding SelectedSecrets.SelectedAppSettings}"
                                                      IsVisible="{Binding SelectedSecrets.HasAppSettings}"
                                                      HorizontalAlignment="Stretch"
                                                      VerticalAlignment="Center">
                                                <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding FileName}"/>
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- AppSettings Content (Read-Only) -->
                                    <controls:JsonEditor Grid.Row="1"
                                             Text="{Binding SelectedSecrets.SelectedAppSettings.Content, Mode=OneWay}"
                                             IsReadOnly="True"/>
                                </Grid>
                            </Border>

                            <!-- Splitter -->
                            <GridSplitter Grid.Column="1" Width="8" Background="Transparent"/>

                            <!-- User Secrets Panel -->
                            <Border Grid.Column="2" CornerRadius="8" ClipToBounds="True"
                                    Background="{DynamicResource SukiCardBackground}">
                                <DockPanel>
                                    <!-- User Secrets Header -->
                                    <Border DockPanel.Dock="Top" Padding="12,0" Height="44"
                                            BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,0,1">
                                        <TextBlock Text="ðŸ” User Secrets" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    </Border>
                                    
                                    <!-- User Secrets Editor -->
                                    <controls:JsonEditor Text="{Binding SelectedSecrets.Content, Mode=TwoWay}"
                                             IsReadOnly="False"/>
                                </DockPanel>
                            </Border>
                        </Grid>
                    </Grid>
                </Grid>
            </Grid>
        </Grid>
    </DockPanel>

    <suki:SukiWindow.Resources>
        <views:BoolToValidationColorConverter x:Key="BoolToValidationColorConverter"/>
        <views:BoolToValidationTextConverter x:Key="BoolToValidationTextConverter"/>
    </suki:SukiWindow.Resources>
</suki:SukiWindow>
